<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#1a1a2e">
<title>ã‚‚ã®ãã•æ‰‹å¸³</title>
<link rel="manifest" href="manifest.json">
<style>
:root{--bg:#f5f5f0;--bg2:#fff;--text:#1a1a2e;--text2:#555;--accent:#2563eb;--accent2:#1d4ed8;--border:#d4d4d4;--header-bg:#1a1a2e;--header-text:#f5f5f0;--danger:#dc2626;--success:#16a34a;--input-bg:#fff;--shadow:0 1px 3px rgba(0,0,0,.08);--radius:8px;--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
[data-theme="dark"]{--bg:#0f0f1a;--bg2:#1a1a2e;--text:#e8e8e8;--text2:#aaa;--border:#333;--header-bg:#0a0a14;--input-bg:#1a1a2e;--shadow:0 1px 3px rgba(0,0,0,.3)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;display:flex;flex-direction:column;-webkit-text-size-adjust:100%;padding-top:var(--safe-top);padding-bottom:var(--safe-bottom)}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit}
input,textarea,select{font-family:inherit;font-size:16px;color:var(--text)}
textarea{resize:vertical}
.header{background:var(--header-bg);color:var(--header-text);display:flex;align-items:center;justify-content:space-between;padding:8px 12px;min-height:44px;position:sticky;top:0;z-index:100}
.header-title{font-size:15px;font-weight:600;letter-spacing:.5px}
.header-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;font-size:18px}
.header-btn:hover{background:rgba(255,255,255,.1)}
.tab-bar{display:flex;background:var(--bg2);border-bottom:1px solid var(--border);position:sticky;top:44px;z-index:99}
.tab-btn{flex:1;padding:10px 0 8px;text-align:center;font-size:12px;font-weight:600;color:var(--tab-inactive,#888);border-bottom:2px solid transparent;transition:all .2s}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-btn svg{display:block;margin:0 auto 3px;width:20px;height:20px}
.tab-content{display:none;flex:1;overflow-y:auto;padding-bottom:20px}
.tab-content.active{display:flex;flex-direction:column}
.month-nav{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg2);border-bottom:1px solid var(--border)}
.month-nav-label{font-size:15px;font-weight:600}
.month-nav-btn{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--bg);font-size:16px;font-weight:700}
.month-nav-btn:hover{background:var(--border)}
.text-input{flex:1;padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius);background:var(--input-bg);font-size:14px;outline:none}
.text-input:focus{border-color:var(--accent)}
.text-area{width:100%;padding:10px;border:1px solid var(--border);border-radius:var(--radius);background:var(--input-bg);font-size:14px;outline:none;min-height:120px;line-height:1.6}
.text-area:focus{border-color:var(--accent)}
.btn{padding:6px 14px;border-radius:var(--radius);font-size:13px;font-weight:600;transition:all .15s}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:var(--accent2)}
.btn-danger{background:var(--danger);color:#fff}
.btn-outline{border:1px solid var(--border);background:var(--bg2)}.btn-outline:hover{background:var(--bg)}
.btn-sm{padding:5px 10px;font-size:12px}
.techo-toolbar{display:flex;gap:4px;padding:8px 12px;flex-wrap:wrap;align-items:center;border-bottom:1px solid var(--border);background:var(--bg2)}
.techo-day{display:flex;align-items:stretch;border-bottom:1px solid var(--border);min-height:44px}
.techo-date{width:52px;min-width:52px;padding:6px 4px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;font-weight:600;border-right:1px solid var(--border);background:var(--bg2)}
.techo-date.today{background:var(--accent);color:#fff}
.techo-date.sunday,.techo-date.holiday{color:var(--danger)}
.techo-date.saturday{color:var(--accent)}
.techo-entries{flex:1;display:flex;flex-direction:column;padding:4px 6px;gap:2px}
.techo-entry{display:flex;align-items:center;gap:4px;min-height:28px}
.techo-main{flex:1;padding:3px 6px;border:none;background:transparent;font-size:13px;border-bottom:1px solid transparent;outline:none;min-width:0}
.techo-main:focus{border-bottom-color:var(--accent)}
.techo-col-btns{display:flex;flex-direction:column;gap:1px;padding:2px}
.techo-col-btn{width:22px;height:22px;font-size:14px;border-radius:4px;color:var(--text2);opacity:.4;display:flex;align-items:center;justify-content:center}
.techo-col-btn:hover{opacity:1;background:var(--border)}
.kakeibo-summary{display:flex;gap:8px;padding:12px;flex-wrap:wrap}
.kakeibo-stat{flex:1;min-width:80px;padding:10px;background:var(--bg);border-radius:var(--radius);text-align:center}
.kakeibo-stat-label{font-size:11px;color:var(--text2);margin-bottom:4px}
.kakeibo-stat-value{font-size:18px;font-weight:700}
.kakeibo-stat-value.positive{color:var(--success)}.kakeibo-stat-value.negative{color:var(--danger)}
.kakeibo-section{padding:8px 12px}
.kakeibo-section-title{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:6px;display:flex;align-items:center;gap:6px}
.kakeibo-section-total{font-size:12px;font-weight:600;margin-left:auto}
.year-table{width:100%;border-collapse:collapse;font-size:13px;margin:8px 0}
.year-table th,.year-table td{padding:8px 6px;text-align:right;border-bottom:1px solid var(--border)}
.year-table th{text-align:left;font-weight:600;color:var(--text2);font-size:12px}
.year-table td:first-child{text-align:left;font-weight:600}
.year-table .total-row{font-weight:700;border-top:2px solid var(--text)}
.memo-selector{display:flex;gap:6px;padding:10px 12px;align-items:center;flex-wrap:wrap}
.memo-select{flex:1;min-width:100px;padding:8px;border:1px solid var(--border);border-radius:var(--radius);background:var(--input-bg);font-size:14px;outline:none}
.memo-select:focus{border-color:var(--accent)}
.memo-toolbar{display:flex;gap:4px;padding:6px 12px;flex-wrap:wrap;align-items:center}
.memo-editor{padding:8px 12px;flex:1;display:flex;flex-direction:column}
.memo-editor textarea{flex:1;min-height:300px}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;align-items:flex-end;justify-content:center}
.modal-overlay.open{display:flex}
.modal-sheet{background:var(--bg2);border-radius:16px 16px 0 0;width:100%;max-width:600px;max-height:85vh;overflow-y:auto;padding:16px 16px calc(16px + var(--safe-bottom));animation:su .25s ease}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border);margin-bottom:12px}
.modal-title{font-size:16px;font-weight:700}
.modal-close{font-size:24px;width:32px;height:32px;display:flex;align-items:center;justify-content:center}
.menu-item{display:flex;align-items:center;gap:10px;padding:12px 8px;border-bottom:1px solid var(--border);font-size:14px;width:100%;text-align:left}
.menu-item:hover{background:var(--bg)}.menu-item:last-child{border-bottom:none}
.menu-icon{font-size:18px;width:28px;text-align:center}
.confirm-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:300;align-items:center;justify-content:center}
.confirm-overlay.open{display:flex}
.confirm-box{background:var(--bg2);border-radius:12px;padding:20px;margin:20px;max-width:300px;text-align:center}
.confirm-msg{font-size:14px;margin-bottom:16px;line-height:1.5}
.confirm-btns{display:flex;gap:8px;justify-content:center}
@media(min-width:768px){body{max-width:800px;margin:0 auto;border-left:1px solid var(--border);border-right:1px solid var(--border)}.techo-main{font-size:14px}.techo-toolbar,.memo-toolbar{justify-content:center}.memo-selector{justify-content:center}.tab-bar{justify-content:center}.tab-btn{max-width:200px}.month-nav{justify-content:center;gap:40px}.kakeibo-summary{justify-content:center}}
@media(min-width:1200px){body{max-width:1000px}}
</style>
</head>
<body>
<div class="header"><div class="header-title">ã‚‚ã®ãã•æ‰‹å¸³</div><button class="header-btn" onclick="openMenu()">â˜°</button></div>
<div class="tab-bar">
<button class="tab-btn active" data-tab="techo" onclick="switchTab('techo')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>æ‰‹å¸³</button>
<button class="tab-btn" data-tab="memo" onclick="switchTab('memo')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>ãƒ¡ãƒ¢</button>
<button class="tab-btn" data-tab="kakeibo" onclick="switchTab('kakeibo')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>å®¶è¨ˆç°¿</button>
</div>
<div class="tab-content active" id="tab-techo">
<div class="month-nav"><button class="month-nav-btn" onclick="techoMonth(-1)">â—€</button><span class="month-nav-label" id="techo-month-label"></span><button class="month-nav-btn" onclick="techoMonth(1)">â–¶</button></div>
<div class="techo-toolbar"><button class="btn btn-primary btn-sm" onclick="openShiftInsert()">ã‚·ãƒ•ãƒˆæŒ¿å…¥</button><button class="btn btn-outline btn-sm" onclick="techoAddCol()">ï¼‹åˆ—</button><button class="btn btn-outline btn-sm" id="techo-rmcol" style="display:none" onclick="techoRmCol()">âˆ’åˆ—</button></div>
<div id="techo-body"></div>
</div>
<div class="tab-content" id="tab-memo">
<div class="memo-selector"><select class="memo-select" id="mc" onchange="mSelCat()"><option value="">-- å¤§ã‚«ãƒ†ã‚´ãƒª --</option></select><select class="memo-select" id="ms" onchange="mSelSub()"><option value="">-- å°ã‚«ãƒ†ã‚´ãƒª --</option></select></div>
<div class="memo-toolbar"><button class="btn btn-outline btn-sm" onclick="mAddCat()">ï¼‹å¤§</button><button class="btn btn-outline btn-sm" onclick="mAddSubMenu()">ï¼‹å°</button><button class="btn btn-outline btn-sm" onclick="mDelCat()">å‰Šé™¤å¤§</button><button class="btn btn-outline btn-sm" onclick="mDelSub()">å‰Šé™¤å°</button><button class="btn btn-outline btn-sm" onclick="mSearch()">æ¤œç´¢</button><button class="btn btn-outline btn-sm" onclick="mReplace()">ç½®æ›</button><button class="btn btn-primary btn-sm" onclick="mTpl()">ğŸ“ãƒ†ãƒ³ãƒ—ãƒ¬</button></div>
<div class="memo-editor"><textarea class="text-area" id="mt" placeholder="ã“ã“ã«å…¥åŠ›..." oninput="mInp()" disabled></textarea></div>
</div>
<div class="tab-content" id="tab-kakeibo">
<div class="month-nav"><button class="month-nav-btn" onclick="kNav(-1)">â—€</button><span class="month-nav-label" id="k-label"></span><button class="month-nav-btn" onclick="kNav(1)">â–¶</button></div>
<div style="padding:8px 12px;display:flex;gap:4px;justify-content:center"><button class="btn btn-outline btn-sm" id="km-m" onclick="kMode('month')" style="font-weight:700">æœˆå˜ä½</button><button class="btn btn-outline btn-sm" id="km-y" onclick="kMode('year')">å¹´å˜ä½</button><button class="btn btn-primary btn-sm" onclick="mTpl()">ğŸ“ãƒ†ãƒ³ãƒ—ãƒ¬</button></div>
<div id="k-mv" style="display:flex;flex-direction:column;flex:1"><div class="kakeibo-summary" id="k-sum"></div><div class="kakeibo-section"><div class="kakeibo-section-title">åå…¥<span class="kakeibo-section-total" id="k-it">Â¥0</span></div><textarea class="text-area" id="k-i" placeholder="åŠè§’æ•°å­—ã§é‡‘é¡ã€å…¨è§’ã§ã‚³ãƒ¡ãƒ³ãƒˆ&#10;ä¾‹: 250000 çµ¦ä¸" oninput="kCalc()"></textarea></div><div class="kakeibo-section" style="flex:1;display:flex;flex-direction:column"><div class="kakeibo-section-title">æ”¯å‡º<span class="kakeibo-section-total" id="k-et">Â¥0</span></div><textarea class="text-area" id="k-e" placeholder="åŠè§’æ•°å­—ã§é‡‘é¡ã€å…¨è§’ã§ã‚³ãƒ¡ãƒ³ãƒˆ&#10;ä¾‹: 80000 å®¶è³ƒ" oninput="kCalc()" style="flex:1;min-height:200px"></textarea></div></div>
<div id="k-yv" style="display:none;padding:8px 12px"></div>
</div>
<div class="modal-overlay" id="menu-modal"><div class="modal-sheet"><div class="modal-header"><span class="modal-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span><button class="modal-close" onclick="closeMenu()">Ã—</button></div>
<button class="menu-item" onclick="xExport()"><span class="menu-icon">ğŸ“¤</span>ZIPã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
<button class="menu-item" onclick="xImport()"><span class="menu-icon">ğŸ“¥</span>ZIPã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
<button class="menu-item" onclick="xDateFix()"><span class="menu-icon">ğŸ•</span>æ—¥ä»˜ä¿®æ­£</button>
<button class="menu-item" onclick="xTheme()"><span class="menu-icon">ğŸ¨</span>ãƒ†ãƒ¼ãƒå¤‰æ›´</button>
<button class="menu-item" onclick="xShiftEdit()"><span class="menu-icon">ğŸ“‹</span>ã‚·ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ç·¨é›†</button>
<button class="menu-item" onclick="xTplEdit()"><span class="menu-icon">ğŸ“</span>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†</button>
<button class="menu-item" onclick="xFirebase()"><span class="menu-icon">â˜ï¸</span>FirebaseåŒæœŸè¨­å®š</button>
<button class="menu-item" onclick="xImportMode()"><span class="menu-icon">âš™ï¸</span>ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰</button>
</div></div>
<div class="confirm-overlay" id="cf"><div class="confirm-box"><div class="confirm-msg" id="cf-msg"></div><div class="confirm-btns"><button class="btn btn-outline" onclick="cfNo()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-danger" onclick="cfYes()">OK</button></div></div></div>
<div class="modal-overlay" id="sub-modal"><div class="modal-sheet" id="smc"></div></div>
<input type="file" id="fi" accept=".zip" style="display:none" onchange="xImportFile(event)">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
const DB='monogusa_',sv=(k,v)=>{try{localStorage.setItem(DB+k,JSON.stringify(v))}catch(e){}},ld=(k,d)=>{try{const v=localStorage.getItem(DB+k);return v?JSON.parse(v):d}catch(e){return d}},uid=()=>crypto.randomUUID?crypto.randomUUID():'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16)});
let S={techoDays:ld('techoDays',{}),shiftPatterns:ld('shiftPatterns',[{uuid:uid(),name:'A',items:[]},{uuid:uid(),name:'B',items:[]},{uuid:uid(),name:'C',items:[]},{uuid:uid(),name:'D',items:[]}]),techoColumns:ld('techoColumns',1),memoCategories:ld('memoCategories',[]),memoTemplates:ld('memoTemplates',[]),kakeiboMonths:ld('kakeiboMonths',{}),settings:ld('settings',{dateCorrection:0,theme:'system',importMode:'overwrite'})};
function ss(keys){if(!keys)keys=Object.keys(S);for(const k of keys)sv(k,S[k]);fbAutoSync();}
let _fbSyncTimer=null;
function fbAutoSync(){if(_fbSyncTimer)clearTimeout(_fbSyncTimer);_fbSyncTimer=setTimeout(()=>{if(window._fbDb&&window._fbUser)fbPushSilent().catch(()=>{})},2000);}
async function fbPushSilent(){if(!window._fbDb||!window._fbUser)return;try{await window._fbDb.collection('users').doc(window._fbUser.uid).set({techoDays:S.techoDays,shiftPatterns:S.shiftPatterns,techoColumns:S.techoColumns,memoCategories:S.memoCategories,memoTemplates:S.memoTemplates,kakeiboMonths:S.kakeiboMonths,updatedAt:new Date().toISOString()})}catch(e){console.error('auto sync error',e)}}
function cn(){return new Date(Date.now()+(S.settings.dateCorrection||0))}
function ts(){const d=cn();return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function cym(){const d=cn();return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}
function am(ym,n){const[y,m]=ym.split('-').map(Number);const d=new Date(y,m-1+n,1);return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}
function dim(ym){const[y,m]=ym.split('-').map(Number);return new Date(y,m,0).getDate()}
function dow(y,m,d){return new Date(y,m-1,d).getDay()}
const DW=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'],HL={};
async function lh(y){if(HL[y])return;try{const r=await fetch(`https://holidays-jp.github.io/api/v1/${y}/date.json`);if(r.ok)HL[y]=await r.json()}catch(e){HL[y]={}}}
function ih(ds){const y=ds.split('-')[0];return HL[y]&&HL[y][ds]}
let ct='techo';
function switchTab(t){ct=t;document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));document.querySelectorAll('.tab-content').forEach(c=>c.classList.toggle('active',c.id==='tab-'+t));if(t==='techo')rT();else if(t==='memo')rM();else if(t==='kakeibo')rK()}
function openMenu(){document.getElementById('menu-modal').classList.add('open')}
function closeMenu(){document.getElementById('menu-modal').classList.remove('open')}
function osm(h){document.getElementById('smc').innerHTML=h;document.getElementById('sub-modal').classList.add('open')}
function csm(){document.getElementById('sub-modal').classList.remove('open')}
let cfCb=null;
function cf(msg,cb){document.getElementById('cf-msg').textContent=msg;cfCb=cb;document.getElementById('cf').classList.add('open')}
function cfYes(){document.getElementById('cf').classList.remove('open');if(cfCb)cfCb();cfCb=null}
function cfNo(){document.getElementById('cf').classList.remove('open');cfCb=null}

// === TECHO ===
let tYM=cym();
function techoMonth(n){tYM=am(tYM,n);rT()}
async function rT(){
  const[y,m]=tYM.split('-').map(Number);await lh(y);
  document.getElementById('techo-month-label').textContent=`${y}å¹´${m}æœˆ`;
  const cols=S.techoColumns;document.getElementById('techo-rmcol').style.display=cols>1?'':'none';
  const days=dim(tYM),td=ts();let h='';
  for(let d=1;d<=days;d++){
    const ds=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dw=dow(y,m,d),it=ds===td,hl=ih(ds);
    let dc='techo-date';if(it)dc+=' today';else if(hl)dc+=' holiday';else if(dw===0)dc+=' sunday';else if(dw===6)dc+=' saturday';
    let dy=S.techoDays[ds];if(!dy)dy={uuid:uid(),date:ds,entries:[]};
    while(dy.entries.length<cols)dy.entries.push({uuid:uid(),main:'',col:dy.entries.length});
    h+=`<div class="techo-day"><div class="${dc}"><span class="techo-date-num">${d}</span><span class="techo-date-day">${DW[dw]}</span></div><div class="techo-entries">`;
    for(let c=0;c<dy.entries.length;c++){const e=dy.entries[c];h+=`<div class="techo-entry" data-date="${ds}" data-col="${c}" data-uuid="${e.uuid}"><input class="techo-main" value="${ea(e.main)}" placeholder="..." oninput="tSv(this,'main')"></div>`}
    h+=`</div><div class="techo-col-btns"><button class="techo-col-btn" onclick="tAdd('${ds}')">ï¼‹</button>${dy.entries.length>cols?`<button class="techo-col-btn" onclick="tRm('${ds}')">âˆ’</button>`:''}</div></div>`;
  }
  document.getElementById('techo-body').innerHTML=h;
  if(tYM===cym()){const el=document.querySelector('.techo-date.today');if(el)el.closest('.techo-day').scrollIntoView({block:'center',behavior:'smooth'})}
}
function tSv(el,f){const en=el.closest('.techo-entry'),ds=en.dataset.date,col=+en.dataset.col,eu=en.dataset.uuid;let dy=S.techoDays[ds];if(!dy)dy={uuid:uid(),date:ds,entries:[]};while(dy.entries.length<=col)dy.entries.push({uuid:uid(),main:'',col:dy.entries.length});dy.entries[col][f]=el.value;dy.entries[col].uuid=eu;S.techoDays[ds]=dy;ss(['techoDays'])}
function techoAddCol(){S.techoColumns++;ss(['techoColumns']);rT()}
function techoRmCol(){if(S.techoColumns<=1)return;cf('æœ€å¾Œã®åˆ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆãˆã¾ã™ã€‚',()=>{S.techoColumns--;for(const ds in S.techoDays){const d=S.techoDays[ds];if(d.entries.length>S.techoColumns)d.entries.length=S.techoColumns}ss(['techoColumns','techoDays']);rT()})}
function tAdd(ds){let dy=S.techoDays[ds];if(!dy)dy={uuid:uid(),date:ds,entries:[]};dy.entries.push({uuid:uid(),main:'',col:dy.entries.length});S.techoDays[ds]=dy;ss(['techoDays']);rT()}
function tRm(ds){cf('æœ€å¾Œã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',()=>{let dy=S.techoDays[ds];if(!dy||dy.entries.length<=S.techoColumns)return;dy.entries.pop();S.techoDays[ds]=dy;ss(['techoDays']);rT()})}
function openShiftInsert(){let h=`<div class="modal-header"><span class="modal-title">ã‚·ãƒ•ãƒˆæŒ¿å…¥</span><button class="modal-close" onclick="csm()">Ã—</button></div><div style="padding:8px"><label style="font-size:13px;font-weight:600">ãƒ‘ã‚¿ãƒ¼ãƒ³</label><select id="sp" class="memo-select" style="margin:6px 0">`;S.shiftPatterns.forEach((p,i)=>{h+=`<option value="${i}">${p.name} (${p.items.length}é …ç›®)</option>`});h+=`</select><label style="font-size:13px;font-weight:600">é–‹å§‹æ—¥</label><input type="date" id="sd" class="text-input" style="margin:6px 0" value="${ts()}"><label style="font-size:13px;font-weight:600">ç¹°ã‚Šè¿”ã—å›æ•°</label><input type="number" id="sr" class="text-input" style="margin:6px 0" value="1" min="1" max="100"><button class="btn btn-primary" style="width:100%;margin-top:12px" onclick="doSI()">æŒ¿å…¥</button></div>`;osm(h)}
function doSI(){const pi=+document.getElementById('sp').value,sd=document.getElementById('sd').value,rep=+document.getElementById('sr').value||1,pat=S.shiftPatterns[pi];if(!pat||!pat.items.length){alert('ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒç©ºã§ã™');return}let cur=new Date(sd+'T00:00:00');for(let i=0;i<pat.items.length*rep;i++){const ds=`${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}-${String(cur.getDate()).padStart(2,'0')}`;let dy=S.techoDays[ds];if(!dy)dy={uuid:uid(),date:ds,entries:[]};if(!dy.entries.length)dy.entries.push({uuid:uid(),main:'',col:0});dy.entries[0].main=pat.items[i%pat.items.length];S.techoDays[ds]=dy;cur.setDate(cur.getDate()+1)}ss(['techoDays']);csm();rT()}

// === MEMO ===
let mC=ld('lastMemoCat',null),mS=ld('lastMemoSub',null);
function rM(){const cs=document.getElementById('mc');let h='<option value="">-- å¤§ã‚«ãƒ†ã‚´ãƒª --</option>';[...S.memoCategories].sort((a,b)=>a.sortOrder-b.sortOrder).forEach(c=>{h+=`<option value="${c.uuid}"${mC===c.uuid?' selected':''}>${es(c.name)}</option>`});cs.innerHTML=h;mSelCat()}
function mSelCat(){const u=document.getElementById('mc').value;mC=u||null;sv('lastMemoCat',mC);const ss2=document.getElementById('ms');let h='<option value="">-- å°ã‚«ãƒ†ã‚´ãƒª --</option>';if(u){const cat=S.memoCategories.find(c=>c.uuid===u);if(cat)[...cat.subs].sort((a,b)=>a.sortOrder-b.sortOrder).forEach(s=>{h+=`<option value="${s.uuid}"${mS===s.uuid?' selected':''}>${es(s.name)}</option>`})}ss2.innerHTML=h;mSelSub()}
function mSelSub(){const u=document.getElementById('ms').value;mS=u||null;sv('lastMemoSub',mS);const ta=document.getElementById('mt');if(mC&&mS){const cat=S.memoCategories.find(c=>c.uuid===mC),sub=cat?.subs?.find(s=>s.uuid===mS);ta.value=sub?.content||'';ta.disabled=false}else{ta.value='';ta.disabled=true}}
function mInp(){if(!mC||!mS)return;const v=document.getElementById('mt').value,ci=S.memoCategories.findIndex(c=>c.uuid===mC);if(ci<0)return;const si=S.memoCategories[ci].subs.findIndex(s=>s.uuid===mS);if(si<0)return;S.memoCategories[ci].subs[si].content=v;S.memoCategories[ci].subs[si].updatedAt=new Date().toISOString();ss(['memoCategories'])}
function mAddCat(){const n=prompt('å¤§ã‚«ãƒ†ã‚´ãƒªå:');if(!n)return;S.memoCategories.push({uuid:uid(),name:n,subs:[],sortOrder:S.memoCategories.length});ss(['memoCategories']);mC=S.memoCategories[S.memoCategories.length-1].uuid;rM()}
function mAddSub(){if(!mC){alert('å¤§ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');return}const n=prompt('å°ã‚«ãƒ†ã‚´ãƒªå:');if(!n)return;const ci=S.memoCategories.findIndex(c=>c.uuid===mC);if(ci<0)return;const sub={uuid:uid(),name:n,content:'',sortOrder:S.memoCategories[ci].subs.length,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};S.memoCategories[ci].subs.push(sub);ss(['memoCategories']);mS=sub.uuid;rM()}
function mAddSubMenu(){if(!mC){alert('å¤§ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');return}let h=`<div class="modal-header"><span class="modal-title">å°ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </span><button class="modal-close" onclick="csm()">Ã—</button></div>`;h+=`<button class="menu-item" onclick="csm();mAddSub()"><span class="menu-icon">âœï¸</span>æ‰‹å…¥åŠ›</button>`;h+=`<button class="menu-item" onclick="csm();mAddSubToday()"><span class="menu-icon">ğŸ“…</span>ä»Šæ—¥ã®æ—¥ä»˜</button>`;h+=`<button class="menu-item" onclick="csm();mAddSubSeq()"><span class="menu-icon">ğŸ”¢</span>é€£ç•ªï¼ˆï¼‹1ï¼‰</button>`;osm(h)}
function mAddSubToday(){if(!mC)return;const d=cn(),name=`${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;const ci=S.memoCategories.findIndex(c=>c.uuid===mC);if(ci<0)return;const sub={uuid:uid(),name,content:'',sortOrder:S.memoCategories[ci].subs.length,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};S.memoCategories[ci].subs.push(sub);ss(['memoCategories']);mS=sub.uuid;rM()}
function mAddSubSeq(){if(!mC)return;const ci=S.memoCategories.findIndex(c=>c.uuid===mC);if(ci<0)return;const subs=S.memoCategories[ci].subs;if(!subs.length){alert('å°ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“');return}const last=subs[subs.length-1].name;let numStr='',numEnd=-1;for(let i=last.length-1;i>=0;i--){const code=last.charCodeAt(i);if(code>=48&&code<=57){numStr=last[i]+numStr;if(numEnd<0)numEnd=i}else if(code>127){continue}else{if(numStr)break}}if(!numStr){alert('æœ«å°¾ã«åŠè§’æ•°å­—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return}const numStart=numEnd-numStr.length+1;const prefix=last.substring(0,numStart);const suffix=last.substring(numEnd+1);const nextNum=parseInt(numStr)+1;const padded=String(nextNum).padStart(numStr.length,'0');const newName=prefix+padded+suffix;const sub={uuid:uid(),name:newName,content:'',sortOrder:subs.length,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};S.memoCategories[ci].subs.push(sub);ss(['memoCategories']);mS=sub.uuid;rM()}
function mDelCat(){if(!mC)return;const cat=S.memoCategories.find(c=>c.uuid===mC);cf(`ã€Œ${cat?.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿä¸­èº«ã‚‚å…¨ã¦æ¶ˆãˆã¾ã™ã€‚`,()=>{S.memoCategories=S.memoCategories.filter(c=>c.uuid!==mC);mC=null;mS=null;ss(['memoCategories']);rM()})}
function mDelSub(){if(!mC||!mS)return;const ci=S.memoCategories.findIndex(c=>c.uuid===mC);if(ci<0)return;const sub=S.memoCategories[ci].subs.find(s=>s.uuid===mS);cf(`ã€Œ${sub?.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`,()=>{S.memoCategories[ci].subs=S.memoCategories[ci].subs.filter(s=>s.uuid!==mS);mS=null;ss(['memoCategories']);rM()})}
function mSearch(){const q=prompt('æ¤œç´¢:');if(!q)return;const ta=document.getElementById('mt'),i=ta.value.indexOf(q);if(i>=0){ta.focus();ta.setSelectionRange(i,i+q.length)}else alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ')}
function mReplace(){const s=prompt('æ¤œç´¢:');if(!s)return;const r=prompt('ç½®æ›:');if(r===null)return;document.getElementById('mt').value=document.getElementById('mt').value.replaceAll(s,r);mInp()}
function mTpl(){if(!S.memoTemplates.length){alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nãƒ¡ãƒ‹ãƒ¥ãƒ¼â†’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');return}let h=`<div class="modal-header"><span class="modal-title">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</span><button class="modal-close" onclick="csm()">Ã—</button></div>`;S.memoTemplates.forEach(t=>{const p=t.content.length>40?t.content.substring(0,40)+'...':t.content;h+=`<button class="menu-item" onclick="doTplCopy('${t.uuid}')"><div><div style="font-weight:600">${es(t.name)}</div><div style="font-size:11px;color:var(--text2)">${es(p)}</div></div></button>`});osm(h)}
function doTplCopy(u){const t=S.memoTemplates.find(x=>x.uuid===u);if(!t)return;navigator.clipboard.writeText(t.content).then(()=>{csm();alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')}).catch(()=>{csm();alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ')})}

// === KAKEIBO ===
let kYM=ld('lastKakeiboYM',null)||cym(),kMd=ld('lastKakeiboMode',null)||'month';
function kNav(n){kYM=am(kYM,n);sv('lastKakeiboYM',kYM);rK()}
function kMode(m){kMd=m;sv('lastKakeiboMode',kMd);document.getElementById('km-m').style.fontWeight=m==='month'?'700':'400';document.getElementById('km-y').style.fontWeight=m==='year'?'700':'400';document.getElementById('k-mv').style.display=m==='month'?'':'none';document.getElementById('k-yv').style.display=m==='year'?'':'none';rK()}
function rK(){const[y,m]=kYM.split('-').map(Number);document.getElementById('k-label').textContent=kMd==='month'?`${y}å¹´${m}æœˆ`:`${y}å¹´`;if(kMd==='month')rKM();else rKY()}
function rKM(){let d=S.kakeiboMonths[kYM];if(!d){d={uuid:uid(),yearMonth:kYM,income:'',expense:''};S.kakeiboMonths[kYM]=d;ss(['kakeiboMonths'])}document.getElementById('k-i').value=d.income;document.getElementById('k-e').value=d.expense;kCalc()}
function kCalc(){const it=document.getElementById('k-i').value,et=document.getElementById('k-e').value,inc=ck(it),exp=ck(et),bal=inc-exp;document.getElementById('k-it').textContent=`Â¥${inc.toLocaleString()}`;document.getElementById('k-et').textContent=`Â¥${exp.toLocaleString()}`;document.getElementById('k-sum').innerHTML=`<div class="kakeibo-stat"><div class="kakeibo-stat-label">åå…¥</div><div class="kakeibo-stat-value positive">Â¥${inc.toLocaleString()}</div></div><div class="kakeibo-stat"><div class="kakeibo-stat-label">æ”¯å‡º</div><div class="kakeibo-stat-value negative">Â¥${exp.toLocaleString()}</div></div><div class="kakeibo-stat"><div class="kakeibo-stat-label">åæ”¯</div><div class="kakeibo-stat-value ${bal>=0?'positive':'negative'}">Â¥${bal.toLocaleString()}</div></div>`;if(!S.kakeiboMonths[kYM])S.kakeiboMonths[kYM]={uuid:uid(),yearMonth:kYM,income:'',expense:''};S.kakeiboMonths[kYM].income=it;S.kakeiboMonths[kYM].expense=et;ss(['kakeiboMonths'])}
function ck(t){let s=0;for(const l of t.split('\n')){const tr=l.trim();if(!tr)continue;let n='';for(const c of tr){const cd=c.charCodeAt(0);if(cd>=48&&cd<=57)n+=c;else if(c==='-'&&n==='')n+=c;else if(cd>127)break;else if(c===' '&&n==='')continue;else break}if(n&&n!=='-'){const v=parseInt(n);if(!isNaN(v))s+=v}}return s}
function rKY(){const yr=+kYM.split('-')[0];let h='<table class="year-table"><tr><th>æœˆ</th><th>åå…¥</th><th>æ”¯å‡º</th><th>åæ”¯</th></tr>',ti=0,te=0;for(let m=1;m<=12;m++){const ym=`${yr}-${String(m).padStart(2,'0')}`,d=S.kakeiboMonths[ym],inc=d?ck(d.income):0,exp=d?ck(d.expense):0,bal=inc-exp;ti+=inc;te+=exp;h+=`<tr><td>${m}æœˆ</td><td>Â¥${inc.toLocaleString()}</td><td>Â¥${exp.toLocaleString()}</td><td style="color:${bal>=0?'var(--success)':'var(--danger)'}">${bal>=0?'+':''}Â¥${bal.toLocaleString()}</td></tr>`}const tb=ti-te;h+=`<tr class="total-row"><td>åˆè¨ˆ</td><td>Â¥${ti.toLocaleString()}</td><td>Â¥${te.toLocaleString()}</td><td style="color:${tb>=0?'var(--success)':'var(--danger)'}">${tb>=0?'+':''}Â¥${tb.toLocaleString()}</td></tr></table>`;document.getElementById('k-yv').innerHTML=h}

// === MENU ===
async function xExport(){closeMenu();const z=new JSZip();z.file('monogusa_data.json',JSON.stringify({version:'1.0.0',exportedAt:new Date().toISOString(),techoDays:S.techoDays,shiftPatterns:S.shiftPatterns,techoColumns:S.techoColumns,memoCategories:S.memoCategories,memoTemplates:S.memoTemplates,kakeiboMonths:S.kakeiboMonths,settings:S.settings},null,2));const b=await z.generateAsync({type:'blob'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`monogusa_${ts()}.zip`;a.click();URL.revokeObjectURL(a.href)}
function xImport(){closeMenu();document.getElementById('fi').click()}
async function xImportFile(e){const f=e.target.files[0];if(!f)return;try{const z=await JSZip.loadAsync(f),jf=z.file('monogusa_data.json');if(!jf){alert('monogusa_data.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return}const d=JSON.parse(await jf.async('string')),ow=S.settings.importMode==='overwrite';if(d.techoDays)for(const[k,v]of Object.entries(d.techoDays)){if(ow||!S.techoDays[k]||JSON.stringify(S.techoDays[k])!==JSON.stringify(v))S.techoDays[k]=v}if(d.shiftPatterns)S.shiftPatterns=d.shiftPatterns;if(d.techoColumns)S.techoColumns=d.techoColumns;if(d.memoCategories)for(const ic of d.memoCategories){const ei=S.memoCategories.findIndex(c=>c.uuid===ic.uuid);if(ei>=0){if(ow||JSON.stringify(S.memoCategories[ei])!==JSON.stringify(ic))S.memoCategories[ei]=ic}else S.memoCategories.push(ic)}if(d.memoTemplates)S.memoTemplates=d.memoTemplates;if(d.kakeiboMonths)for(const[k,v]of Object.entries(d.kakeiboMonths)){if(ow||!S.kakeiboMonths[k]||JSON.stringify(S.kakeiboMonths[k])!==JSON.stringify(v))S.kakeiboMonths[k]=v}ss();alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');switchTab(ct)}catch(err){alert('ã‚¨ãƒ©ãƒ¼: '+err.message)}e.target.value=''}
function xDateFix(){closeMenu();const h=Math.round((S.settings.dateCorrection||0)/3600),v=prompt(`æ—¥ä»˜ä¿®æ­£å€¤ï¼ˆæ™‚é–“å˜ä½ï¼‰\nç¾åœ¨: ${h}æ™‚é–“\nä¾‹: 24=1æ—¥é€²ã‚€, -24=1æ—¥æˆ»ã‚‹`,h);if(v===null)return;S.settings.dateCorrection=(parseInt(v)||0)*3600;ss(['settings']);switchTab(ct)}
function xTheme(){closeMenu();let h=`<div class="modal-header"><span class="modal-title">ãƒ†ãƒ¼ãƒå¤‰æ›´</span><button class="modal-close" onclick="csm()">Ã—</button></div>`;[{id:'system',n:'ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã«å¾“ã†'},{id:'light',n:'ãƒ©ã‚¤ãƒˆ'},{id:'dark',n:'ãƒ€ãƒ¼ã‚¯'}].forEach(t=>{const s=S.settings.theme===t.id?' style="font-weight:700;color:var(--accent)"':'';h+=`<button class="menu-item"${s} onclick="setTh('${t.id}')">${t.n}</button>`});osm(h)}
function setTh(t){S.settings.theme=t;ss(['settings']);apTh();csm()}
function apTh(){const t=S.settings.theme;if(t==='dark')document.body.setAttribute('data-theme','dark');else if(t==='light')document.body.removeAttribute('data-theme');else{if(window.matchMedia('(prefers-color-scheme:dark)').matches)document.body.setAttribute('data-theme','dark');else document.body.removeAttribute('data-theme')}}
function xShiftEdit(){closeMenu();let h=`<div class="modal-header"><span class="modal-title">ã‚·ãƒ•ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ç·¨é›†</span><button class="modal-close" onclick="csm()">Ã—</button></div><div style="padding:8px">`;S.shiftPatterns.forEach((p,i)=>{h+=`<div style="margin-bottom:12px"><div style="font-weight:700;margin-bottom:4px">ãƒ‘ã‚¿ãƒ¼ãƒ³ ${p.name} (${p.items.length}/90)</div><textarea class="text-area" id="se${i}" style="min-height:80px" placeholder="1è¡Œ1é …ç›®">${p.items.join('\n')}</textarea></div>`});h+=`<button class="btn btn-primary" style="width:100%" onclick="svSP()">ä¿å­˜</button></div>`;osm(h)}
function svSP(){S.shiftPatterns.forEach((p,i)=>{const ta=document.getElementById('se'+i);if(ta)p.items=ta.value.split('\n').map(s=>s.trim()).filter(s=>s).slice(0,90)});ss(['shiftPatterns']);csm()}
function xTplEdit(){closeMenu();let h=`<div class="modal-header"><span class="modal-title">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†</span><button class="modal-close" onclick="csm()">Ã—</button></div><div style="padding:8px">`;S.memoTemplates.forEach((t,i)=>{h+=`<div style="margin-bottom:10px;border:1px solid var(--border);border-radius:var(--radius);padding:8px"><div style="display:flex;gap:4px;align-items:center;margin-bottom:4px"><input class="text-input" value="${ea(t.name)}" id="tn${i}" placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬å" style="flex:1"><button class="btn btn-danger btn-sm" onclick="dTpl(${i})">å‰Šé™¤</button></div><textarea class="text-area" id="tc${i}" style="min-height:60px" placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å®¹">${es(t.content)}</textarea></div>`});h+=`<button class="btn btn-outline" style="width:100%;margin:8px 0" onclick="aTpl()">ï¼‹è¿½åŠ </button><button class="btn btn-primary" style="width:100%" onclick="svTpl()">ä¿å­˜</button></div>`;osm(h)}
function aTpl(){S.memoTemplates.push({uuid:uid(),name:'',content:''});ss(['memoTemplates']);xTplEdit()}
function dTpl(i){S.memoTemplates.splice(i,1);ss(['memoTemplates']);xTplEdit()}
function svTpl(){S.memoTemplates.forEach((t,i)=>{const n=document.getElementById('tn'+i),c=document.getElementById('tc'+i);if(n)t.name=n.value;if(c)t.content=c.value});ss(['memoTemplates']);csm()}
const FB_CONFIG={apiKey:"AIzaSyDJzuz6MnNa5FYh1byDXKXnt4bnhic7iXU",authDomain:"monogusav3.firebaseapp.com",projectId:"monogusav3",storageBucket:"monogusav3.firebasestorage.app",messagingSenderId:"594529013883",appId:"1:594529013883:web:7760632dfe3fac99fd92de"};
function xFirebase(){closeMenu();const li=!!window._fbUser;let h=`<div class="modal-header"><span class="modal-title">FirebaseåŒæœŸ</span><button class="modal-close" onclick="csm()">Ã—</button></div><div style="padding:8px">`;if(!li){h+=`<p style="font-size:13px;margin-bottom:12px">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™ã€‚</p><button class="btn btn-primary" style="width:100%" onclick="fbLogin()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>`}else{h+=`<p style="font-size:13px;margin-bottom:8px">ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <strong>${es(window._fbUser.email||'')}</strong></p><p style="font-size:12px;color:var(--text2);margin-bottom:12px">ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«åŒæœŸã•ã‚Œã¾ã™ã€‚</p><button class="btn btn-outline" style="width:100%" onclick="fbLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>`}h+=`</div>`;osm(h)}
async function fbInit(){
  if(window._fbApp)return;
  if(!window.firebase){await lsc('https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js');await lsc('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js');await lsc('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js')}
  window._fbApp=firebase.initializeApp(FB_CONFIG);window._fbAuth=firebase.auth();window._fbDb=firebase.firestore();
  window._fbAuth.onAuthStateChanged(async u=>{window._fbUser=u||null;if(u)await fbMerge()});
}
function lsc(src){return new Promise((ok,ng)=>{const s=document.createElement('script');s.src=src;s.onload=ok;s.onerror=ng;document.head.appendChild(s)})}
async function fbLogin(){try{await fbInit();const r=await window._fbAuth.signInWithPopup(new firebase.auth.GoogleAuthProvider());window._fbUser=r.user;csm();await fbMerge()}catch(e){alert('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: '+e.message)}}
function fbLogout(){if(window._fbAuth)window._fbAuth.signOut();window._fbUser=null;csm()}

// è‡ªå‹•ãƒãƒ¼ã‚¸ï¼ˆèµ·å‹•æ™‚ãƒ»ãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼‰
async function fbMerge(){
  if(!window._fbDb||!window._fbUser)return;
  try{
    const doc=await window._fbDb.collection('users').doc(window._fbUser.uid).get();
    if(!doc.exists){fbPushSilent();return}
    const sv2=doc.data();let conflicts=[];
    // æ‰‹å¸³ãƒãƒ¼ã‚¸
    if(sv2.techoDays){for(const[k,v]of Object.entries(sv2.techoDays)){
      if(!S.techoDays[k])S.techoDays[k]=v;
      else if(JSON.stringify(S.techoDays[k])!==JSON.stringify(v))conflicts.push({type:'æ‰‹å¸³',key:k,local:S.techoDays[k],server:v,apply:sv3=>{S.techoDays[k]=sv3}});
    }}
    // å®¶è¨ˆç°¿ãƒãƒ¼ã‚¸
    if(sv2.kakeiboMonths){for(const[k,v]of Object.entries(sv2.kakeiboMonths)){
      if(!S.kakeiboMonths[k])S.kakeiboMonths[k]=v;
      else if(JSON.stringify(S.kakeiboMonths[k])!==JSON.stringify(v))conflicts.push({type:'å®¶è¨ˆç°¿',key:k,local:S.kakeiboMonths[k],server:v,apply:sv3=>{S.kakeiboMonths[k]=sv3}});
    }}
    // ãƒ¡ãƒ¢ãƒãƒ¼ã‚¸ï¼ˆUUIDæ¯”è¼ƒï¼‰
    if(sv2.memoCategories){for(const sc of sv2.memoCategories){
      const li=S.memoCategories.findIndex(c=>c.uuid===sc.uuid);
      if(li<0)S.memoCategories.push(sc);
      else if(JSON.stringify(S.memoCategories[li])!==JSON.stringify(sc)){
        const idx=li;conflicts.push({type:'ãƒ¡ãƒ¢',key:sc.name,local:S.memoCategories[idx],server:sc,apply:sv3=>{S.memoCategories[idx]=sv3}});
      }
    }}
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒãƒ¼ã‚¸
    if(sv2.memoTemplates){for(const st of sv2.memoTemplates){
      const li=S.memoTemplates.findIndex(t=>t.uuid===st.uuid);
      if(li<0)S.memoTemplates.push(st);
      else if(JSON.stringify(S.memoTemplates[li])!==JSON.stringify(st))S.memoTemplates[li]=st;
    }}
    // ã‚·ãƒ•ãƒˆãƒ»åˆ—æ•°ã¯ã‚µãƒ¼ãƒãƒ¼å„ªå…ˆï¼ˆç«¶åˆå°‘ãªã„ï¼‰
    if(sv2.shiftPatterns)S.shiftPatterns=sv2.shiftPatterns;
    if(sv2.techoColumns&&sv2.techoColumns>S.techoColumns)S.techoColumns=sv2.techoColumns;

    if(conflicts.length>0){await resolveConflicts(conflicts)}
    ss();switchTab(ct);
  }catch(e){console.error('merge error',e)}
}

// ç«¶åˆè§£æ±ºUI
let _conflicts=[],_cIdx=0;
function resolveConflicts(list){
  return new Promise(ok=>{_conflicts=list;_cIdx=0;window._conflictDone=ok;showConflict()});
}
function showConflict(){
  if(_cIdx>=_conflicts.length){window._conflictDone();return}
  const c=_conflicts[_cIdx];
  const localPrev=typeof c.local==='object'?JSON.stringify(c.local).substring(0,80)+'...':'';
  const serverPrev=typeof c.server==='object'?JSON.stringify(c.server).substring(0,80)+'...':'';
  let h=`<div class="modal-header"><span class="modal-title">ç«¶åˆ (${_cIdx+1}/${_conflicts.length})</span></div><div style="padding:8px">`;
  h+=`<p style="font-size:13px;font-weight:600;margin-bottom:8px">${es(c.type)}: ${es(c.key)}</p>`;
  h+=`<div style="margin-bottom:8px;padding:8px;background:var(--bg);border-radius:var(--radius);font-size:11px"><strong>ãƒ­ãƒ¼ã‚«ãƒ«:</strong><br>${es(localPrev)}</div>`;
  h+=`<div style="margin-bottom:12px;padding:8px;background:var(--bg);border-radius:var(--radius);font-size:11px"><strong>ã‚µãƒ¼ãƒãƒ¼:</strong><br>${es(serverPrev)}</div>`;
  h+=`<button class="btn btn-outline" style="width:100%;margin-bottom:4px" onclick="pickConflict('local')">ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ä½¿ã†</button>`;
  h+=`<button class="btn btn-primary" style="width:100%" onclick="pickConflict('server')">ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ã†</button>`;
  h+=`</div>`;osm(h);
}
function pickConflict(choice){
  const c=_conflicts[_cIdx];
  if(choice==='server')c.apply(c.server);
  // localãªã‚‰ãã®ã¾ã¾
  _cIdx++;
  if(_cIdx>=_conflicts.length){csm();window._conflictDone()}
  else showConflict();
}
function xImportMode(){closeMenu();let h=`<div class="modal-header"><span class="modal-title">ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰</span><button class="modal-close" onclick="csm()">Ã—</button></div>`;[{id:'overwrite',n:'ä¸Šæ›¸ã',d:'UUIDä¸€è‡´ã¯ä¸Šæ›¸ãã€åŒä¸€ã¯ã‚¹ã‚­ãƒƒãƒ—'},{id:'diff',n:'å·®åˆ†',d:'UUIDä¸€è‡´ã‹ã¤å·®ç•°ã‚ã‚Šã®ã¿æ›´æ–°'}].forEach(m=>{const s=S.settings.importMode===m.id?' style="font-weight:700;color:var(--accent)"':'';h+=`<button class="menu-item"${s} onclick="sIM('${m.id}')"><div><div>${m.n}</div><div style="font-size:11px;color:var(--text2)">${m.d}</div></div></button>`});osm(h)}
function sIM(m){S.settings.importMode=m;ss(['settings']);csm()}

function es(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function ea(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

apTh();window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change',()=>{if(S.settings.theme==='system')apTh()});
tYM=cym();rT();
// å®¶è¨ˆç°¿ãƒ¢ãƒ¼ãƒ‰å¾©å…ƒ
if(kMd!=='month'){document.getElementById('km-m').style.fontWeight='400';document.getElementById('km-y').style.fontWeight='700';document.getElementById('k-mv').style.display='none';document.getElementById('k-yv').style.display=''}
document.getElementById('menu-modal').addEventListener('click',e=>{if(e.target.id==='menu-modal')closeMenu()});
document.getElementById('sub-modal').addEventListener('click',e=>{if(e.target.id==='sub-modal')csm()});
if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
fbInit().catch(()=>{});
</script>
</body>
</html>
